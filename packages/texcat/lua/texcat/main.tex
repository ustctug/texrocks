\makeatletter
\def\$[u]{command_prefix}@reset{\let\$[u]{command_prefix}@it=\relax \let\$[u]{command_prefix}@bf=\relax
    \let\$[u]{command_prefix}@ul=\relax \let\$[u]{command_prefix}@tc=\relax
    \let\$[u]{command_prefix}@bc=\relax \let\$[u]{command_prefix}@ff=\relax}
\def\$[u]{command_prefix}@tok#1{\csname $[u]{command_prefix}@tok@#1\endcsname}
\def\$[u]{command_prefix}@toks#1+{\ifx\relax#1\empty\else
    \$[u]{command_prefix}@tok{#1}\expandafter\$[u]{command_prefix}@toks\fi}
\def\$[u]{command_prefix}@do#1{\$[u]{command_prefix}@bc{\$[u]{command_prefix}@tc{\$[u]{command_prefix}@ul{
    \$[u]{command_prefix}@it{\$[u]{command_prefix}@bf{\$[u]{command_prefix}@ff{#1}}}}}}}
\def\$[u]{command_prefix}#1#2{\$[u]{command_prefix}@reset\$[u]{command_prefix}@toks#1+\relax+\$[u]{command_prefix}@do{#2}}
<l:for names="_, scope" in="ipairs(scopes)">
\@namedef{$[u]{command_prefix}@tok@$[u]{scope:gsub('%-', '_')}}{\def\$[u]{command_prefix}@tc##1{<l:if cond="color_map[scope][1] < 0">##1<l:else/>\textcolor[rgb]{${color_map[scope][1]/255},${color_map[scope][2]/255},${color_map[scope][3]/255}}{##1}</l:if>}}</l:for>

\def\$[u]{command_prefix}Zbs{\char`\\}
\def\$[u]{command_prefix}Zus{\char`\_}
\def\$[u]{command_prefix}Zob{\char`\{}
\def\$[u]{command_prefix}Zcb{\char`\}}
\def\$[u]{command_prefix}Zca{\char`\^}
\def\$[u]{command_prefix}Zam{\char`\&}
\def\$[u]{command_prefix}Zlt{\char`\<}
\def\$[u]{command_prefix}Zgt{\char`\>}
\def\$[u]{command_prefix}Zsh{\char`\#}
\def\$[u]{command_prefix}Zpc{\char`\%}
\def\$[u]{command_prefix}Zdl{\char`\$}
\def\$[u]{command_prefix}Zhy{\char`\-}
\def\$[u]{command_prefix}Zsq{\char`\'}
\def\$[u]{command_prefix}Zdq{\char`\"}
\def\$[u]{command_prefix}Zti{\char`\~}
\makeatother

\begin{Verbatim}[commandchars=\\\{\},codes={\catcode`\$=3\catcode`\^=7\catcode`\_=8\relax}]
<l:for names="_, hl" in="ipairs(hls)"><l:if cond="hl.text == '\n'">
<l:else/>\$[u]{command_prefix}{$[n]{hl.scope:gsub('%-', '_')}}{$[n]{escape(hl.text, command_prefix)}}</l:if></l:for>
\end{Verbatim}
